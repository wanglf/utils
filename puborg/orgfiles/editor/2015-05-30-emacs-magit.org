#+TITLE: Emacs Magit
#+AUTHOR: Micky Ching
#+OPTIONS: H:4 ^:nil
#+LATEX_CLASS: latex-doc
#+PAGE_TAGS: emacs

* 基本配置
#+HTML: <!--abstract-begin-->

在仓库下面执行 =M-x magit-status= 就能进入magit模式，
由于这个命令在笔者的工作中使用极其频繁，故以将其绑定到 =F8=。

在这个模式下有许多按键可以使用，可以执行 =C-h m= 查看该模式下的所有按键，
下表是最常用到的按键。

| g | 刷新状态     | G | 刷新所有状态    |
| s | 添加当前更改 | S | 添加所有更改    |
| u | 撤销当前更改 | U | 撤销所有更改    |
| k | 删除当前更改 | X | 删除所有更改    |
| c | 提交         | x | reset           |
| d | 查看差异     | e | 用ediff显示差异 |
| P | 远程推送     | F | 远程拉取        |
| E | 交互式rebase |   |                 |
| b | 分支切换     |   |                 |
| l | 列举日志     |   |                 |
#+HTML: <!--abstract-end-->

* 状态区管理
状态区分三个大区，如下表所示。
| Untracked files  | 未跟踪，不能查看具体内容      |
| Unstaged changes | 已更改未提交，能看到diff hunk |
| Staged changes   | 已提交的更改，能看到diff hunk |
这里说到状态区，主要是对差异区的操作，所有对差异区的操作是通用的，
即后面会讲到查看log的时候也能开启差异区，都是创建一个临时缓冲区来显示。
在差异区按回车就能进入到对应的代码区。

在状态窗口下，可以折叠和打开要显示的差异级别，
数字按键1、2、3、4用于控制当前区域显示深度，
M-1、M-2、M-3、M-4用于控制所有区域显示深度。
TAB按键可用于折叠和打开当前区域。

差异区常用的快捷键如下表所示：
| n   | next diff hunk    | p | prev diff hunk |
| +   | 增大diff区        | - | 减小diff区     |
| 0   | 复位diff区大小    |   |                |
| ^   | 跳转到父区域      |   |                |
| H   | 高亮/取消字符差异 |   |                |

** 文件状态
文件状态处理常用操作如下表所示，可以精确到字符，如果是在一个差异区操作，
就是对该差异区处理，如果在差异区选中一段字符，就是对选中的字符操作。
| s     | 添加更改           | u     | 撤销更改                |
| k     | 删除更改           | X     | 删除所有修改            |
| C-u S | 添加所有更改       | C-u s | 选择性添加              |
| i     | 忽略到.gitignore   | I     | 忽略到.git/info/exclude |
| S     | 添加所有差异区     | U     | 撤销所有差异区          |
| +     | 增加diff区显示宽度 | -     | 减少diff区显示宽度      |
| c     | 进入提交会话       |       |                         |

提交会话可以选择的参数如下图所示。
file:fig/magit/magit-commit.png

进入提交编辑会话之后，常用操作如下表所示。
| M-p       | 上一条消息    | M-n     | 下一条消息  |
| C-c C-k   | 取消提交      | C-c C-c | 完成提交    |
| C-c C-a   | Acked-by      | C-c C-r | Reviewed-by |
| C-c C-s   | Signed-off-by | C-c C-t | Tested-by   |

** 暂存区
按键 =z= 进入暂存区会话，如下图所示。
file:fig/magit/magit-stash.png

* 历史记录
在状态区输入 =l= 即可查看历史，详细参数如下图所示。
file:fig/magit/magit-log.png

如果要看最近一次提交的修改内容，其实没有必要进入历史会话，
直接在状态模式下将光标移动到提交标题按回车就可以查看差异，
这会创建一个 =*magit-commit*= 缓冲区显示差异。
对差异区的操作和前面提到的操作方式完全一样。

如果要查看早期提交的内容，就需要进入历史会话，
创建一个叫 =*magit-log*= 的临时缓冲区。
在该缓冲区任意提交处按回车就能打开一个 =*magit-commit*= 缓冲区。
在历史缓冲区也可以使用 =n/p= 进行上下移动，和普通移动的不同之处在于，
它会更新差异区内容。

在历史输出中，有许多实用的按键，如下表所示。
| a   | 将提交应用到当前分支             |
| A   | 在没有冲突时将提交应用到当前分支 |
| v   | 反提交                           |
| C-w | 复制sha1                         |
| =   | 和标记的提交生成差异             |
| .   | 标记/反标记                      |

* 查看差异
| d | 查看工作树和其他分支或提交的差异 |
| D | 查看任意两个提交间的差异         |
| v | 反提交选中的差异                 |
| e | 用ediff显示差异                  |

这里贴几张图以显示不同模式查看差异的区别。

#+CAPTION: 普通差异模式(d)
file:fig/magit/magit-diff.png

#+CAPTION: 细分差异模式(H)
file:fig/magit/magit-cdiff.png

#+CAPTION: 横向差异模式(e)
file:fig/magit/magit-ediff.png

* 分支管理
| 主按键 | 子按键 | 功能                             |
|--------+--------+----------------------------------|
| b      |        | 开启分支管理菜单                 |
|        | b      | 切换分支                         |
|        | c      | 创建分支                         |
|        | k      | 删除分支                         |
|        | C-u k  | 删除分支，即便未合并也能删除     |
|        | r      | 重命名分支                       |
|        | v      | 进入分支管理器                   |
|--------+--------+----------------------------------|
| b v    |        | 分支管理器，上面的子命令都可使用 |
|        | RET    | 切换                             |
|        | T      | 更改跟踪的远程分支               |
|--------+--------+----------------------------------|
| w      |        | 显示其他和当前分支相关的分支     |

** 合并与变基
| 主按键 | 子按键 | 功能             |
|--------+--------+------------------|
| m      |        | 进入合并会话     |
|        | m      | 开始合并         |
|        | X      | 退出合并         |
|        | e      | 处理冲突         |
|        | S      | 添加冲突解决文件 |
|--------+--------+------------------|
| R      |        | 进入变基会话     |
|--------+--------+------------------|
| E      |        | 进入交互式变基   |
|        | R C    | 处理完冲突后继续 |
|        | R S    | 忽略冲突提交     |
|        | R A    | 退出变基         |

** 标签
| 主按键 | 子按键 | 功能         |
|--------+--------+--------------|
| t      |        | 进入标签会话 |
|        | c      | 创建标签     |
|        | k      | 删除标签     |

* 远程管理
| 主按键 | 子按键 | 功能                             |
|--------+--------+----------------------------------|
| M      |        | 开启远程管理菜单                 |
|        | a      | 添加远程仓库                     |
|        | k      | 删除远程仓库                     |
|        | r      | 重命名远程仓库                   |
|--------+--------+----------------------------------|
| P      |        | 进入推送会话                     |
|        | P      | 推送分支                         |
|--------+--------+----------------------------------|
| f      |        | 进入fetch会话                    |
|        | f      | git fetch                        |
|--------+--------+----------------------------------|
| F      |        | 进入pull会话                     |
|        | F      | git pull                         |

* 子模块
| 主按键 | 子按键 | 功能            |
|--------+--------+-----------------|
| o      |        | 进入子模块会话  |
|        | u      | update          |
|        | i      | init            |
|        | b      | update and init |
|        | s      | sync            |

* 参考资料
- [[http://magit.github.io/master/magit.html][Magit User Manual]]
