#+TITLE: Linux调试工具
#+AUTHOR: Micky Ching
#+OPTIONS: H:4 ^:nil
#+LATEX_CLASS: latex-doc
#+PAGE_TAGS: gdb

* gcc编译工具
** 基本用法
#+HTML: <!--abstract-begin-->
GCC将C代码编译成可执行程序，会执行预处理、编译、汇编和链接四个步骤。
预处理包含头文件，替换宏定义。编译是由C代码生成汇编程序。
汇编则是将汇编程序转换为目标二进制文件。链接是把目标文件和库链接在一起，
生成一个可以运行的程序。
#+HTML: <!--abstract-end-->

最常用的gcc选项如下所示。
- -E :: 预处理之后就停下来，不执行编译
- -S :: 编译之后就停下来，不执行汇编
- -c :: 编译之后停下来，不执行链接
- -o FILE :: 指定输出文件
- -M :: 输出依赖关系，包含系统头文件
- -MM :: 输出依赖关系，不包含系统头文件
- -MF :: 指定用于输出依赖关系的文件
- -Wwarn... :: 用于指定警告级别
- -I :: 指定头文件搜索路径
- -L :: 指定库文件搜索路径
- -lLIBNAME :: 指定链接库
- -g :: 产生调试信息
- -On :: 指定代码优化级别
- -D name=definition :: 预定义一个宏
- -static :: 禁止链接动态库
- -shared :: 生成共享对象，打开这个选项也需要开启 =-fPIC= 选项，
     PIC的含义是Position-independent code

* gdb调试工具
GDB是Linux下的一个命令行调试工具，当然也可以结合Emacs等编辑器使用。
相较于VS等IDE调试工具，GDB也有自身的长处，主要可以完成如下功能。
- 按照指定要求启动程序
- 设置断点，条件断点等
- 在断点处检查程序状态
- 动态改变程序执行环境

要在启动的时候传递参数可以使用如下命令启动GDB。
#+BEGIN_SRC sh
gdb --args prog arg1 arg2...
#+END_SRC
要调试的步骤可以写入到脚本中，假定脚本名为 =gdbsteps.sh=，
包含如下内容。
#+BEGIN_SRC sh
file hello
break 5
run
c
q
#+END_SRC

可以用如下命令启动。
#+BEGIN_SRC sh
gdb -x gdbsteps.sh
#+END_SRC

GDB基本命令如下表所示。
| 简写 | 全拼       | 含义               |
|------+------------+--------------------|
| b    | breakpoint |                    |
| c    | continue   |                    |
| del  | delete     |                    |
| fin  | finish     | 运行到当前函数返回 |
| h    | help       |                    |
|      | info       |                    |
| l    | list       |                    |
| n    | next       |                    |
| q    | quit       |                    |
| r    | run        |                    |
|      | start      |                    |
| s    | step       |                    |
|      | watch      |                    |
|      | what       |                    |


** 断点
| 命令             | 含义                             |
|------------------+----------------------------------|
| b LINE           |                                  |
| b FUNC           |                                  |
| disable BP...    |                                  |
| enable BP...     |                                  |
| clear LINE       |                                  |
| clear FUNC       |                                  |
| delete BP        |                                  |
| delete           | 删除所有断点                     |
| c                | 继续执行                         |
| s                | 单步执行，进入子函数             |
| n                | 单步执行，不进入子函数           |
| condition BP EXP | 满足表达式才暂停                 |
| until LINE       | 执行到指定行                     |
| info break       | 查看所有断点                     |
| display EXP      | 当断点到达时，自动打印表达式的值 |
| tbreak           | 临时断点，只起作用一次           |


** 查看状态
| 命令      | 含义                 |
|-----------+----------------------|
| l NUM     | 查看指定行号附近代码 |
| p VAR     | 打印变量             |
| bt        | 查看状态             |
| frame     | 查看栈帧             |
| watch VAR | 观察一个变量的变化   |

*** list
| 命令   | 含义               |
|--------+--------------------|
| l      | 显示后面10行       |
| l -    | 显示前面10行       |
| l LINE | 显示指定行附近代码 |
| l FUNC | 显示函数附近代码   |

*** print和x
| 命令                 | 含义           |
|----------------------+----------------|
| p/x                  | 十六进制       |
| p/t                  | 二进制         |
| p/d                  | 无符号整型     |
| p/c                  | 字符型         |
| p                    | 整型           |
| p $eax               | 打印寄存器值   |
| p *(int *)0x8ff4bc10 | 打印内存中的值 |

除了print可以打印信息，x也可打印。
| 命令    | 含义         |
|---------+--------------|
| x/s var | 打印字符串   |
| x/x var | 打印十六进制 |
| x/d var | 打印整数     |
| x/c var | 打印字符     |
| x/i var | 反汇编       |

** 多线程
重要命令
- info thread :: 查看当前进程的线程
- info threads :: 显示所有可调试线程
- thread ID :: 切换调试线程
- break FNAME:LINE thread all :: 为所有经过这里的线程设置断点
- thread apply T1 T2... command :: 让多个线程执行给定命令
- set scheduler-locking off|on|step ::
  - off :: 不锁定任何线程
  - on :: 则只有当前被调试线程会执行
  - step :: 是单步的时候只有当前线程执行

* 参考资料
- [[https://sourceware.org/gdb/current/onlinedocs/gdb/][GDB User Manual]]
- [[http://wiki.ubuntu.org.cn/index.php?title%3D%25E7%2594%25A8GDB%25E8%25B0%2583%25E8%25AF%2595%25E7%25A8%258B%25E5%25BA%258F&variant%3Dzh-hans][用GDB调试程序]]
- [[http://linuxtools-rst.readthedocs.org/zh_CN/latest/tool/gdb.html][gdb调试利器]]
- [[http://www.cnblogs.com/wuyuegb2312/archive/2013/03/29/2987025.html][gdb调试命令]]
